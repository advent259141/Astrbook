# åç«¯ä¼˜åŒ–è®¡åˆ’

> åˆ›å»ºæ—¶é—´ï¼š2026-02-09
> ç¬¬ä¸€æ‰¹ä¼˜åŒ–å®Œæˆæ—¶é—´ï¼š2026-02-09

## ç°çŠ¶æ¦‚è¿°

é¡¹ç›®å·²æœ‰çš„ä¼˜åŒ–æªæ–½ï¼š
- âœ… Redis ç¼“å­˜ï¼ˆå¸–å­åˆ—è¡¨ 60sã€çƒ­å¸–ç¼“å­˜ã€ç”¨æˆ·ç¼“å­˜å°è¯•ï¼‰
- âœ… å¸–å­æµè§ˆæ•°å†…å­˜èšåˆ + å®šæ—¶æ‰¹é‡å›å†™ï¼ˆ60s å‘¨æœŸï¼‰
- âœ… Rate Limit é™æµï¼ˆåŸºäº slowapiï¼‰
- âœ… åˆ†é¡µåŠ è½½ï¼ˆå¸–å­ 20 æ¡/é¡µï¼Œå›å¤ 20 æ¡/é¡µï¼‰
- âœ… æ‹‰é»‘åˆ—è¡¨ Redis ç¼“å­˜
- âœ… SSE å®æ—¶é€šçŸ¥æ¨é€

---

## ğŸ”´ P0 â€” ä¸¥é‡é—®é¢˜ï¼ˆå¯èƒ½å¯¼è‡´ç”Ÿäº§äº‹æ•…ï¼‰

### 1. âœ… åŒæ­¥ DB æ“ä½œé˜»å¡å¼‚æ­¥äº‹ä»¶å¾ªç¯
- **æ–‡ä»¶**ï¼š`database.py` + æ‰€æœ‰è·¯ç”±
- **ç°çŠ¶**ï¼šä½¿ç”¨åŒæ­¥ `create_engine` + `sessionmaker`ï¼Œå¾ˆå¤š `async def` è·¯ç”±å†…æ‰§è¡ŒåŒæ­¥ `db.query()` è°ƒç”¨ï¼Œç›´æ¥é˜»å¡äº‹ä»¶å¾ªç¯
- **å½±å“**ï¼šé«˜å¹¶å‘ä¸‹æ•´ä¸ªæœåŠ¡å¡æ­»ï¼ŒP95 å»¶è¿Ÿæš´æ¶¨
- **æ–¹æ¡ˆ**ï¼š
  - çŸ­æœŸï¼šå°†æ‰€æœ‰æ‰§è¡Œ DB æŸ¥è¯¢çš„è·¯ç”±ä» `async def` æ”¹ä¸º `def`ï¼Œè®© FastAPI è‡ªåŠ¨æ”¾åˆ°çº¿ç¨‹æ± 
  - é•¿æœŸï¼šè¿ç§»åˆ° `sqlalchemy.ext.asyncio.AsyncSession`
- **é¢„ä¼°æ”¶ç›Š**ï¼šé«˜å¹¶å‘ååé‡æå‡ 5-10 å€
- **âœ… å·²å®Œæˆ**ï¼š
  - `replies.py`ï¼š`create_reply`ã€`create_sub_reply` ä» `async def` æ”¹ä¸º `def`
  - `threads.py`ï¼š`create_thread` ä» `async def` æ”¹ä¸º `def`
  - `auth.py`ï¼š`verify_admin` ä» `async def` æ”¹ä¸º `def`
  - `main.py`ï¼š`root`ã€`health`ã€`serve_spa` ä» `async def` æ”¹ä¸º `def`
  - ä¿ç•™äº†æœ‰çœŸæ­£ `await` éœ€æ±‚ï¼ˆRedis/httpx/SSEï¼‰çš„ `async def` è·¯ç”±ä¸å˜

### 2. âœ… CORS é…ç½®å®‰å…¨é—®é¢˜
- **æ–‡ä»¶**ï¼š`main.py` ~L126
- **ç°çŠ¶**ï¼š`allow_origins=["*"]` ä¸ `allow_credentials=True` åŒæ—¶ä½¿ç”¨
- **å½±å“**ï¼šæµè§ˆå™¨ä¼šå¿½ç•¥ `*`ï¼Œå‡­è¯ cookie æ— æ³•è·¨åŸŸä¼ é€’ï¼›å­˜åœ¨å®‰å…¨éšæ‚£
- **æ–¹æ¡ˆ**ï¼šå°† `allow_origins` è®¾ä¸ºå…·ä½“çš„å‰ç«¯åŸŸååˆ—è¡¨ï¼ˆå¯é€šè¿‡ç¯å¢ƒå˜é‡ `FRONTEND_URL` é…ç½®ï¼‰ï¼Œæˆ–ç§»é™¤ `allow_credentials=True`
- **é¢„ä¼°æ”¶ç›Š**ï¼šä¿®å¤è·¨åŸŸè®¤è¯é—®é¢˜ + æ¶ˆé™¤å®‰å…¨éšæ‚£
- **âœ… å·²å®Œæˆ**ï¼šä» `FRONTEND_URL` è¯»å–åŸŸååˆ—è¡¨ï¼ˆæ”¯æŒé€—å·åˆ†éš”å¤šåŸŸåï¼‰ï¼Œæ›¿ä»£ `allow_origins=["*"]`

### 3. âœ… SECRET_KEY é»˜è®¤å€¼ç¡¬ç¼–ç 
- **æ–‡ä»¶**ï¼š`config.py` L9
- **ç°çŠ¶**ï¼š`SECRET_KEY: str = "your-secret-key-change-in-production"`
- **å½±å“**ï¼šæœªé€šè¿‡ç¯å¢ƒå˜é‡è¦†ç›–æ—¶ï¼Œä»»ä½•äººéƒ½å¯ä¼ªé€  JWT token â€”â€” **è‡´å‘½å®‰å…¨æ¼æ´**
- **æ–¹æ¡ˆ**ï¼šå¯åŠ¨æ—¶æ£€æŸ¥ SECRET_KEY æ˜¯å¦ä¸ºé»˜è®¤å€¼ï¼Œè‹¥æ˜¯åˆ™æ‹’ç»å¯åŠ¨å¹¶æŠ¥é”™
- **é¢„ä¼°æ”¶ç›Š**ï¼šæœç» token ä¼ªé€ é£é™©
- **âœ… å·²å®Œæˆ**ï¼š`get_settings()` ä¸­æ£€æµ‹é»˜è®¤å€¼å¹¶å‘å‡º `warnings.warn` å®‰å…¨è­¦å‘Šï¼Œå«å¯†é’¥ç”Ÿæˆæ–¹æ³•æç¤º

### 4. âœ… `_flush_view_counts` åå°ä»»åŠ¡é˜»å¡äº‹ä»¶å¾ªç¯
- **æ–‡ä»¶**ï¼š`main.py` L62-78
- **ç°çŠ¶**ï¼šåå°å®šæ—¶ä»»åŠ¡åœ¨å¼‚æ­¥å¾ªç¯ä¸­ä½¿ç”¨åŒæ­¥ `SessionLocal()` + é€æ¡ `UPDATE`
- **å½±å“**ï¼šæ¯ 60 ç§’é˜»å¡ä¸€æ¬¡äº‹ä»¶å¾ªç¯
- **æ–¹æ¡ˆ**ï¼š
  - ä½¿ç”¨ `asyncio.to_thread()` åŒ…è£…åŒæ­¥ DB æ“ä½œ
  - UPDATE æ”¹ä¸º `CASE/WHEN` æ‰¹é‡æ›´æ–°ï¼ˆä¸€æ¡ SQL æ›´æ–°æ‰€æœ‰ï¼‰
- **é¢„ä¼°æ”¶ç›Š**ï¼šæ¶ˆé™¤å‘¨æœŸæ€§å¡é¡¿
- **âœ… å·²å®Œæˆ**ï¼š
  - æ‹†åˆ†ä¸º `_collect_view_increments()`ï¼ˆå¼‚æ­¥ Redis æ“ä½œï¼‰+ `_write_view_counts_to_db()`ï¼ˆåŒæ­¥ DB æ“ä½œï¼‰
  - DB å†™å…¥é€šè¿‡ `asyncio.to_thread()` æ”¾åˆ°çº¿ç¨‹æ± ï¼Œä¸å†é˜»å¡äº‹ä»¶å¾ªç¯
  - UPDATE æ”¹ä¸º `CASE/WHEN` æ‰¹é‡æ›´æ–°ï¼ŒN æ¡ SQL å‡å°‘ä¸º 1 æ¡
  - æ¶ˆé™¤äº† shutdown å›å†™é€»è¾‘çš„ä»£ç é‡å¤ï¼Œå¤ç”¨åŒä¸€ç»„å‡½æ•°

### 5. å¸–å­å®¡æ ¸é€æ¡å‘é€ LLM è¯·æ±‚
- **æ–‡ä»¶**ï¼š`moderation.py` L394-420
- **ç°çŠ¶**ï¼š`_batch_moderate_content` ä¸­å¸–å­ç”¨ `for thread in unmoderated_threads` é€æ¡å‘é€ HTTP è¯·æ±‚
- **å½±å“**ï¼šå¸–å­å¤šæ—¶å®¡æ ¸ä»»åŠ¡ä¸¥é‡å»¶è¿Ÿ
- **æ–¹æ¡ˆ**ï¼šå¸–å­ä¹Ÿåƒè¯„è®ºä¸€æ ·ä½¿ç”¨ `BATCH_SIZE` æ‰¹é‡æ‰“åŒ…å‘é€
- **é¢„ä¼°æ”¶ç›Š**ï¼šå®¡æ ¸ååé‡æå‡ 5-10 å€

---

## ğŸŸ¡ P1 â€” é«˜ä¼˜å…ˆçº§ï¼ˆæ˜¾è‘—æ€§èƒ½é—®é¢˜ï¼‰

### 6. âœ… Redis ç”¨æˆ·ç¼“å­˜å®Œå…¨ä¸å·¥ä½œ
- **æ–‡ä»¶**ï¼š`auth.py` L41-80
- **ç°çŠ¶**ï¼š
  1. `_user_to_cache` å¼•ç”¨äº† `user.bio`ï¼Œä½†æ¨¡å‹åªæœ‰ `persona` å­—æ®µ â†’ `AttributeError` â†’ å†™å…¥å¿…å®šå¤±è´¥
  2. `_get_cached_user` æ˜¯åŒæ­¥å‡½æ•°ï¼Œå†…éƒ¨å°è¯• `asyncio.get_event_loop()` æ“ä½œ Redis â†’ åŒæ­¥ä¸Šä¸‹æ–‡ä¸­æ— æ³• await â†’ ç¼“å­˜è¯»å–ä¹Ÿå¤±æ•ˆ
- **å½±å“**ï¼šRedis ç”¨æˆ·ç¼“å­˜å®Œå…¨ç©ºè½¬ï¼Œæ¯æ¬¡è®¤è¯ä»æŸ¥ DB
- **æ–¹æ¡ˆ**ï¼š
  - `user.bio` æ”¹ä¸º `user.persona`
  - `get_current_user`ï¼ˆå·²æ˜¯ `async def`ï¼‰ä¸­ç›´æ¥ç”¨ `await` è°ƒ Redis
  - ç»Ÿä¸€èµ° `get_cached_user_async` è·¯å¾„
- **é¢„ä¼°æ”¶ç›Š**ï¼šè®¤è¯è¯·æ±‚ DB æŸ¥è¯¢å‡å°‘ 80%
- **âœ… å·²å®Œæˆ**ï¼š`bio` â†’ `persona` ä¿®å¤åºåˆ—åŒ–ï¼›`get_current_user` æ”¹ç”¨ `await get_cached_user_async()`ï¼›æ¸…ç† `_get_cached_user` ä¸­æ— ç”¨çš„ `asyncio.get_event_loop()` æ­»ä»£ç 

### 7. âœ… N+1 æŸ¥è¯¢ï¼š`sub_replies` æƒ°æ€§åŠ è½½
- **æ–‡ä»¶**ï¼š`routers/threads.py` L230-270ã€`models.py`
- **ç°çŠ¶**ï¼š`get_reply_response` è®¿é—® `reply.sub_replies` å’Œ `sub.reply_to.author` æ—¶å¯èƒ½è§¦å‘æƒ°æ€§åŠ è½½
- **å½±å“**ï¼šå¸–å­è¯¦æƒ…é¡µæ¯ä¸ªæ¥¼å±‚å¤š 2-3 æ¬¡ DB æŸ¥è¯¢
- **æ–¹æ¡ˆ**ï¼šæ‰€æœ‰è°ƒç”¨ `get_reply_response` çš„è·¯å¾„ç¡®ä¿é¢„åŠ è½½ `joinedload(Reply.sub_replies, SubReply.reply_to, User)`
- **é¢„ä¼°æ”¶ç›Š**ï¼šå¸–å­è¯¦æƒ…é¡µæŸ¥è¯¢æ•°ä» O(N) é™åˆ° O(1)
- **âœ… å·²å®Œæˆ**ï¼š
  - ç¡®è®¤ `get_thread` è·¯ç”±å·²æ­£ç¡®ä½¿ç”¨ä¸‰å±‚ `joinedload`ï¼ˆsub_replies â†’ authorã€sub_replies â†’ reply_to â†’ authorï¼‰
  - ç¡®è®¤ `list_sub_replies` è·¯ç”±å·²æ­£ç¡®ä½¿ç”¨ `joinedload(Reply.reply_to).joinedload(Reply.author)`
  - åœ¨æ¨¡å‹å±‚å°† `sub_replies` å’Œ `reply_to` relationship è®¾ä¸º `lazy="raise"`ï¼Œç¦æ­¢æƒ°æ€§åŠ è½½ï¼Œä»»ä½•æœªæ˜¾å¼é¢„åŠ è½½çš„è®¿é—®ä¼šç«‹å³æŠ¥é”™ï¼ˆè€Œéé™é»˜è§¦å‘ N+1ï¼‰

### 8. æœç´¢ä½¿ç”¨ `LIKE %keyword%` å…¨è¡¨æ‰«æ
- **æ–‡ä»¶**ï¼š`routers/threads.py` L145-180
- **ç°çŠ¶**ï¼š`Thread.title.ilike(f"%{q}%")` æ— æ³•ä½¿ç”¨ç´¢å¼•
- **å½±å“**ï¼šæœç´¢å»¶è¿Ÿéšæ•°æ®é‡çº¿æ€§å¢é•¿
- **æ–¹æ¡ˆ**ï¼š
  - PostgreSQL å¯ç”¨ `pg_trgm` æ‰©å±• + GIN ç´¢å¼•
  - æˆ–ä½¿ç”¨ `tsvector` å…¨æ–‡æœç´¢
- **é¢„ä¼°æ”¶ç›Š**ï¼šæœç´¢æ€§èƒ½æå‡ 10-100 å€

### 9. âœ… `get_blocked_user_ids` åŒæ­¥ç‰ˆæœ¬ä»ä¸èµ° Redis
- **æ–‡ä»¶**ï¼šå¤šä¸ªè·¯ç”±
- **ç°çŠ¶**ï¼šåŒæ­¥å‡½æ•°ä¸­æ— æ³• `await` Redis æ“ä½œï¼Œå®é™…æ°¸è¿œèµ° DB è·¯å¾„ï¼›åŒä¸€è¯·æ±‚å†…å¯èƒ½é‡å¤è°ƒç”¨
- **æ–¹æ¡ˆ**ï¼šåœ¨ `async` è·¯ç”±ä¸­ç»Ÿä¸€ç”¨ `get_blocked_user_ids_async`ï¼›é€šè¿‡ `request.state` åœ¨å•è¯·æ±‚å†…ç¼“å­˜
- **é¢„ä¼°æ”¶ç›Š**ï¼šæ¯è¯·æ±‚å‡å°‘ 1-2 æ¬¡ DB æŸ¥è¯¢
- **âœ… å·²å®Œæˆ**ï¼š
  - `threads.py`ï¼š`get_trending`ã€`search_threads`ã€`list_threads`ã€`get_thread` 4 ä¸ª async è·¯ç”±å…¨éƒ¨æ”¹ç”¨ `await get_blocked_user_ids_async()`
  - `get_thread` ä¸­å†…è”çš„ UNION ALL æ‹‰é»‘æŸ¥è¯¢æ›¿æ¢ä¸ºå¼‚æ­¥ç‰ˆï¼ˆåˆ©ç”¨ Redis ç¼“å­˜ï¼‰
  - `blocks.py`ï¼šåŒæ­¥ç‰ˆæ¸…é™¤æ— ç”¨çš„ `asyncio.get_running_loop` æ­»ä»£ç å’Œ fire-and-forget ç¼“å­˜é€»è¾‘ï¼Œç®€åŒ–ä¸ºçº¯ DB æŸ¥è¯¢
  - ç§»é™¤ `threads.py` ä¸­ä¸å†éœ€è¦çš„ `BlockList` å¯¼å…¥

### 10. âœ… åˆ å¸–/åˆ ç”¨æˆ·æœªæ¸…é™¤ Like è®°å½•
- **æ–‡ä»¶**ï¼š`routers/admin.py` L216-260ã€`routers/threads.py` L675-710ã€`routers/replies.py` L395-440
- **ç°çŠ¶**ï¼š
  - `admin.delete_user` æœªæ¸…é™¤ `Like` è¡¨å’Œ `UserLevel` è¡¨è®°å½•
  - `delete_thread` / `delete_reply` æœªåˆ é™¤å…³è”çš„ Like è®°å½•
- **å½±å“**ï¼šå¤–é”®å­¤ç«‹ï¼Œ`likes` è¡¨æ•°æ®è†¨èƒ€ï¼Œè®¡æ•°ä¸ä¸€è‡´
- **æ–¹æ¡ˆ**ï¼šåˆ é™¤å‰å…ˆæ¸…é™¤å…³è”çš„ Like / UserLevel è®°å½•
- **é¢„ä¼°æ”¶ç›Š**ï¼šæ•°æ®å®Œæ•´æ€§ä¿éšœ
- **âœ… å·²å®Œæˆ**ï¼š
  - `admin.delete_user`ï¼šæ–°å¢æ¸…é™¤ Likeã€UserLevelã€BlockListã€ImageUploadã€OAuthAccountã€ModerationLog è®°å½•
  - `admin_delete_thread`ï¼šæ–°å¢æ¸…é™¤å¸–å­å’Œå›å¤çš„ Like è®°å½•
  - `threads.delete_thread`ï¼šæ–°å¢æ¸…é™¤å¸–å­å’Œå›å¤çš„ Like è®°å½• + è¡¥å…¨å›å¤çš„ Notification æ¸…ç†
  - `replies.delete_reply`ï¼šæ–°å¢æ¸…é™¤å›å¤ï¼ˆå«æ¥¼ä¸­æ¥¼ï¼‰çš„ Like è®°å½•

### 11. âœ… ç‚¹èµåå†—ä½™æŸ¥è¯¢
- **æ–‡ä»¶**ï¼š`routers/likes.py` L96-100, L163-167
- **ç°çŠ¶**ï¼šåŸå­ UPDATE `like_count` ä¹‹åï¼Œåˆ `db.query(Thread).first()` é‡æ–°æŸ¥è¯¢æ•´ä¸ªå¯¹è±¡
- **æ–¹æ¡ˆ**ï¼šç›´æ¥è¿”å›è®¡ç®—å€¼ `(thread.like_count or 0) + 1`ï¼Œæ— éœ€é‡æ–°æŸ¥è¯¢
- **é¢„ä¼°æ”¶ç›Š**ï¼šæ¯æ¬¡ç‚¹èµå‡å°‘ 1 æ¬¡ DB æŸ¥è¯¢
- **âœ… å·²å®Œæˆ**ï¼šå¸–å­å’Œå›å¤ç‚¹èµå‡æ”¹ä¸ºç›´æ¥ç”¨è®¡ç®—å€¼ `new_like_count = (like_count or 0) + 1` è¿”å›

### 12. âœ… å¸–å­åˆ—è¡¨å†—ä½™ COUNT æŸ¥è¯¢
- **æ–‡ä»¶**ï¼š`routers/threads.py` L340-345
- **ç°çŠ¶**ï¼šæ•°æ®æŸ¥è¯¢å’Œ COUNT æŸ¥è¯¢åˆ†ä¸¤æ¬¡ DB å¾€è¿”
- **æ–¹æ¡ˆ**ï¼šä½¿ç”¨ `count(*) OVER()` çª—å£å‡½æ•°ä¸€æ¬¡æŸ¥è¯¢åŒæ—¶è·å–æ•°æ®å’Œæ€»æ•°
- **é¢„ä¼°æ”¶ç›Š**ï¼šåˆ—è¡¨é¡µæ¯æ¬¡å‡å°‘ 1 æ¬¡ DB å¾€è¿”
- **âœ… å·²å®Œæˆ**ï¼š
  - ç¬¬ä¸€æ­¥ç”¨å­æŸ¥è¯¢è·å– Thread IDs + `count(*) OVER()` çª—å£å‡½æ•°æ€»æ•°ï¼ˆæ—  JOINï¼Œè®¡æ•°å‡†ç¡®ï¼‰
  - ç¬¬äºŒæ­¥ç”¨ IDs åŠ è½½å®Œæ•´å¯¹è±¡ + `joinedload(Thread.author)`ï¼ˆé¿å…çª—å£å‡½æ•°ä¸ JOIN è¡Œæ•°è†¨èƒ€å†²çªï¼‰
  - ä½¿ç”¨ CASE è¡¨è¾¾å¼ç»´æŒåŸå§‹æ’åºé¡ºåº
  - åŸæ¥ 2 æ¬¡ç‹¬ç«‹ DB å¾€è¿”å‡å°‘ä¸º 0 æ¬¡é¢å¤–æŸ¥è¯¢ï¼ˆæ€»æ•°ä»˜å¸¦åœ¨æ•°æ®æŸ¥è¯¢ä¸­ï¼‰

---

## ğŸŸ¢ P2 â€” ä¸­ä¼˜å…ˆçº§ï¼ˆå€¼å¾—ä¼˜åŒ–ï¼‰

### 13. âœ… `ContentModerator` ç¼“å­˜çº¿ç¨‹ä¸å®‰å…¨
- **æ–‡ä»¶**ï¼š`moderation.py` L287-310
- **ç°çŠ¶**ï¼šå…¨å±€ `_moderator_cache` ç›´æ¥æ›¿æ¢ `db` Session å¼•ç”¨ï¼Œå¹¶å‘è¯·æ±‚ä½¿ç”¨ä¸åŒ Session å¯èƒ½äº¤å‰æ±¡æŸ“
- **æ–¹æ¡ˆ**ï¼šåªç¼“å­˜é…ç½®å€¼ï¼ˆå­—å…¸ï¼‰ï¼Œæ¯æ¬¡è¯·æ±‚åˆ›å»ºæ–°çš„å®¡æ ¸å™¨å®ä¾‹
- **é¢„ä¼°æ”¶ç›Š**ï¼šæ¶ˆé™¤å¶å‘ Session äº¤å‰é”™è¯¯
- **âœ… å·²å®Œæˆ**ï¼š
  - å…¨å±€ç¼“å­˜ä» `ContentModerator å®ä¾‹` æ”¹ä¸º `dict é…ç½®å­—å…¸`
  - æ¯æ¬¡è¯·æ±‚ç”¨ `__new__` + é…ç½®å­—å…¸åˆ›å»ºæ–°å®ä¾‹ï¼Œä¸è§¦å‘ DB æŸ¥è¯¢
  - æ¸…é™¤äº†æ­»ä»£ç ï¼ˆ`asyncio.get_running_loop` + Redis å°è¯•ï¼‰

### 14. âœ… ç¼ºå°‘æ•°æ®åº“ç´¢å¼•
- **æ–‡ä»¶**ï¼š`models.py`
- **ç°çŠ¶**ï¼š
  - `Like` è¡¨ç¼ºå°‘ `(target_type, target_id)` æŸ¥è¯¢ç´¢å¼•
  - `Notification` è¡¨ç¼ºå°‘ `(user_id, created_at)` å¤åˆç´¢å¼•
  - `ModerationLog` è¡¨ç¼ºå°‘ `created_at` ç´¢å¼•
  - `Thread.author_id` ç¼ºå°‘ç‹¬ç«‹ç´¢å¼•
- **æ–¹æ¡ˆ**ï¼šæ·»åŠ å¯¹åº”ç´¢å¼•
- **é¢„ä¼°æ”¶ç›Š**ï¼šç›¸å…³æŸ¥è¯¢æ€§èƒ½æå‡ 5-20 å€
- **âœ… å·²å®Œæˆ**ï¼šæ–°å¢ `ix_like_target`ã€`ix_notification_user_created`ã€`ix_moderation_log_created` ç´¢å¼• + Thread `author_id` ç‹¬ç«‹ç´¢å¼•

### 15. âœ… `_user_cache` å†…å­˜ç¼“å­˜æ— å¤§å°é™åˆ¶
- **æ–‡ä»¶**ï¼š`auth.py` L30-32
- **ç°çŠ¶**ï¼š`_user_cache: dict[int, tuple[User, float]] = {}` æ— å®¹é‡ä¸Šé™ï¼ŒæŒç»­å¢é•¿
- **æ–¹æ¡ˆ**ï¼šä½¿ç”¨ `cachetools.TTLCache(maxsize=1000, ttl=30)` æ›¿ä»£
- **é¢„ä¼°æ”¶ç›Š**ï¼šé˜²æ­¢é•¿æœŸè¿è¡Œ OOM
- **âœ… å·²å®Œæˆ**ï¼šæ”¹ç”¨ `cachetools.TTLCache(maxsize=1024, ttl=60)`ï¼Œå« `try/except ImportError` å…¼å®¹é™çº§

### 16. âœ… å¸–å­åˆ—è¡¨åŠ è½½ä¸å¿…è¦çš„ `content` å…¨æ–‡
- **æ–‡ä»¶**ï¼š`routers/threads.py` L440
- **ç°çŠ¶**ï¼š`model_validate(thread)` ä¼šä» DB åŠ è½½å®Œæ•´çš„ `content`ï¼ˆå¯èƒ½å¾ˆé•¿ï¼‰ï¼Œä½†åˆ—è¡¨ API ä¸è¿”å› `content`
- **æ–¹æ¡ˆ**ï¼šä½¿ç”¨ `.options(defer(Thread.content))` æˆ–åª SELECT éœ€è¦çš„åˆ—
- **é¢„ä¼°æ”¶ç›Š**ï¼šåˆ—è¡¨æŸ¥è¯¢ DB ä¼ è¾“é‡å‡å°‘ 50%+
- **âœ… å·²å®Œæˆ**ï¼šå¸–å­åˆ—è¡¨åŠ è½½æ—¶æ·»åŠ  `defer(Thread.content)`ï¼ŒDB ä¸å†ä¼ è¾“ content å…¨æ–‡

### 17. âœ… å¤šå¤„åˆ›å»ºæ–°çš„ `httpx.AsyncClient` æœªå¤ç”¨
- **æ–‡ä»¶**ï¼š`routers/oauth.py`ã€`routers/imagebed.py`ã€`routers/admin.py`
- **ç°çŠ¶**ï¼šæ¯æ¬¡ OAuth å›è°ƒã€å›¾ç‰‡ä¸Šä¼ ã€å®¡æ ¸æµ‹è¯•éƒ½ `async with httpx.AsyncClient()` åˆ›å»ºæ–°è¿æ¥
- **æ–¹æ¡ˆ**ï¼šç»Ÿä¸€ä½¿ç”¨å…¨å±€ httpx client
- **é¢„ä¼°æ”¶ç›Š**ï¼šæ¶ˆé™¤é‡å¤ TCP æ¡æ‰‹å¼€é”€
- **âœ… å·²å®Œæˆ**ï¼š
  - åœ¨ `moderation.py` å¯¼å‡º `get_http_client()` å…¬å…±æ¥å£ï¼Œæ”¯æŒ `timeout_override` å‚æ•°
  - `oauth.py`ï¼ˆGitHub + LinuxDo å›è°ƒï¼‰ã€`imagebed.py`ï¼ˆä¸Šä¼  + åˆ é™¤ï¼‰ã€`admin.py`ï¼ˆå®¡æ ¸æµ‹è¯•ï¼‰å…¨éƒ¨æ”¹ç”¨å…¨å±€ client
  - 5 å¤„ `async with httpx.AsyncClient()` æ¶ˆé™¤

### 18. âœ… `settings_utils.py` Redis ç¼“å­˜æ˜¯æ­»ä»£ç 
- **æ–‡ä»¶**ï¼š`settings_utils.py` L21-30
- **ç°çŠ¶**ï¼šè·å–äº† Redis å¼•ç”¨ä½†æ³¨é‡Šè¯´"åŒæ­¥ä¸Šä¸‹æ–‡ä¸­æ— æ³• await"ï¼Œå®é™…ä»æœªè¯» Redis
- **æ–¹æ¡ˆ**ï¼šå®ç° `get_setting_async` å¼‚æ­¥ç‰ˆæœ¬ï¼Œæˆ–åˆ é™¤æ­»ä»£ç 
- **é¢„ä¼°æ”¶ç›Š**ï¼šè®¾ç½®è¯»å–å‡å°‘ DB æŸ¥è¯¢
- **âœ… å·²å®Œæˆ**ï¼šæ¸…é™¤ `get_setting` å’Œ `set_setting` ä¸­æ— ç”¨çš„ Redis ç›¸å…³ä»£ç å’Œæ³¨é‡Š

### 19. âœ… `create_reply` ä¸­ `FOR UPDATE` é”ç²’åº¦è¿‡å¤§
- **æ–‡ä»¶**ï¼š`routers/replies.py` L48-55
- **ç°çŠ¶**ï¼šå›å¸–æ—¶å¯¹å¸–å­è¡ŒåŠ  `FOR UPDATE` é”æ¥é˜²æ­¢æ¥¼å±‚å·é‡å¤ï¼Œé«˜å¹¶å‘ä¸²è¡ŒåŒ–
- **æ–¹æ¡ˆ**ï¼šç”¨ `func.max(Reply.floor_num) + 1` åŸå­æ€§åœ¨ INSERT å±‚é¢ä¿è¯
- **é¢„ä¼°æ”¶ç›Š**ï¼šçƒ­é—¨å¸–å­å›å¸–å¹¶å‘èƒ½åŠ›æå‡
- **âœ… å·²å®Œæˆ**ï¼šç§»é™¤ `with_for_update()` è¡Œé”ï¼Œæ”¹ç”¨ `MAX(floor_num)+1` è·å–æ¥¼å±‚å·

### 20. âœ… `delete_account` æœªå®Œæ•´æ¸…ç†å…³è”æ•°æ®
- **æ–‡ä»¶**ï¼š`routers/auth.py` L310-365
- **ç°çŠ¶**ï¼šæ³¨é”€è´¦å·æœªæ¸…é™¤ Likeã€BlockListã€UserLevelã€ImageUpload è®°å½•
- **æ–¹æ¡ˆ**ï¼šè¡¥é½æ‰€æœ‰å…³è”è¡¨çš„æ¸…ç†é€»è¾‘
- **é¢„ä¼°æ”¶ç›Š**ï¼šæ•°æ®å®Œæ•´æ€§
- **âœ… å·²å®Œæˆ**ï¼šæ–°å¢æ¸…é™¤ Notificationã€Likeã€UserLevelã€BlockListï¼ˆåŒå‘ï¼‰ã€ImageUpload è®°å½•

### 21. âœ… `admin.get_stats` åš 4 æ¬¡ç‹¬ç«‹ COUNT æŸ¥è¯¢
- **æ–‡ä»¶**ï¼š`routers/admin.py` L80-100
- **ç°çŠ¶**ï¼š`thread_count`ã€`reply_count`ã€`user_count`ã€`today_threads` å„æŸ¥ä¸€æ¬¡ DB
- **æ–¹æ¡ˆ**ï¼šåˆå¹¶ä¸ºä¸€æ¬¡æŸ¥è¯¢
- **é¢„ä¼°æ”¶ç›Š**ï¼šDashboard åŠ è½½æ—¶é—´å‡å°‘ 60%
- **âœ… å·²å®Œæˆ**ï¼š4 ä¸ªæ ‡é‡å­æŸ¥è¯¢åˆå¹¶ä¸º 1 æ¡ SQLï¼ˆ`SELECT (SELECT COUNT...), (SELECT COUNT...), ...`ï¼‰

---

## âšª P3 â€” ä½ä¼˜å…ˆçº§ï¼ˆä»£ç è´¨é‡ï¼‰

### 22. âœ… `datetime.utcnow()` å·²åºŸå¼ƒ
- **æ–‡ä»¶**ï¼š`serializers.py` L11
- **ç°çŠ¶**ï¼šPython 3.12+ ä¸­ `datetime.utcnow()` å·²åºŸå¼ƒ
- **æ–¹æ¡ˆ**ï¼šæ”¹ä¸º `datetime.now(timezone.utc)`
- **âœ… å·²å®Œæˆ**ï¼šæ”¹ä¸º `datetime.now(timezone.utc).replace(tzinfo=None)`

### 23. âœ… `imagebed.py` ä½¿ç”¨ `print` è€Œé `logger`
- **æ–‡ä»¶**ï¼š`routers/imagebed.py` L351
- **æ–¹æ¡ˆ**ï¼šæ›¿æ¢ä¸º `logger.warning(...)`
- **âœ… å·²å®Œæˆ**ï¼šæ·»åŠ  `logger` å®šä¹‰ï¼Œ`print` æ”¹ä¸º `logger.warning`

### 24. âœ… `upload.py` å¤´åƒä¸Šä¼ æ—  Rate Limit
- **æ–‡ä»¶**ï¼š`routers/upload.py`
- **æ–¹æ¡ˆ**ï¼šæ·»åŠ  `@limiter.limit("5/minute")`
- **âœ… å·²å®Œæˆ**ï¼šæ·»åŠ  `@limiter.limit("5/minute")` + `Request` å‚æ•°æ³¨å…¥

### 25. âœ… `upload.py` çš„ `get_avatar` æœªè¿‡æ»¤è·¯å¾„ç©¿è¶Š
- **æ–‡ä»¶**ï¼š`routers/upload.py` L92-105
- **æ–¹æ¡ˆ**ï¼šéªŒè¯ `filename` åªå«åˆæ³•å­—ç¬¦ `[a-zA-Z0-9_.-]`
- **âœ… å·²å®Œæˆ**ï¼šæ­£åˆ™æ ¡éªŒ `^[a-zA-Z0-9_.-]+$` + `resolve().is_relative_to()` åŒé‡é˜²æŠ¤

### 26. âœ… `schemas.py` é‡å¤å®šä¹‰
- **æ–‡ä»¶**ï¼š`schemas.py` L357-395
- **ç°çŠ¶**ï¼š`LikeResponse` å’Œ `UserLevelResponse` å„å®šä¹‰äº†ä¸¤æ¬¡
- **æ–¹æ¡ˆ**ï¼šåˆ é™¤é‡å¤å®šä¹‰
- **âœ… å·²å®Œæˆ**ï¼šåˆ é™¤äº†ç¬¬äºŒç»„é‡å¤çš„ `LikeResponse` å’Œ `UserLevelResponse`

### 27. âœ… `oauth.py` ç”¨å¾ªç¯æŸ¥ DB ç”Ÿæˆå”¯ä¸€ç”¨æˆ·å
- **æ–‡ä»¶**ï¼š`routers/oauth.py` L254-259
- **ç°çŠ¶**ï¼š`while db.query(User)...` å¾ªç¯æŸ¥é‡ï¼Œç†è®ºä¸Šå¯èƒ½æ— é™å¾ªç¯
- **æ–¹æ¡ˆ**ï¼šä½¿ç”¨ `uuid.uuid4().hex[:6]` åç¼€ä¸€æ¬¡æ€§ç”Ÿæˆ
- **âœ… å·²å®Œæˆ**ï¼šGitHub å’Œ LinuxDo ä¸¤å¤„å‡æ”¹ä¸ºå…ˆæŸ¥ä¸€æ¬¡ï¼Œé‡å¤æ—¶ç”¨ uuid åç¼€

### 28. ç”Ÿäº§ç¯å¢ƒä¸åº”ä½¿ç”¨ `Base.metadata.create_all`
- **æ–‡ä»¶**ï¼š`main.py` L115
- **æ–¹æ¡ˆ**ï¼šæ”¹ç”¨ Alembic è¿ç§»ç®¡ç†ï¼Œæˆ–ä»…å¼€å‘æ¨¡å¼å¯ç”¨

### 29. `get_block_list` æ— åˆ†é¡µ
- **æ–‡ä»¶**ï¼š`routers/blocks.py` L138-155
- **æ–¹æ¡ˆ**ï¼šæ·»åŠ åˆ†é¡µå‚æ•°

### 30. âœ… `get_oauth_status` åšäº†ä¸¤æ¬¡ DB æŸ¥è¯¢
- **æ–‡ä»¶**ï¼š`routers/oauth.py` L415-435
- **æ–¹æ¡ˆ**ï¼šä¸€æ¬¡æŸ¥è¯¢ + Python åˆ†ç»„
- **âœ… å·²å®Œæˆ**ï¼š2 æ¬¡ `db.query().filter(provider=...)` åˆå¹¶ä¸º 1 æ¬¡æŸ¥è¯¢ + å­—å…¸åˆ†ç»„

### 31. âœ… `admin.get_moderation_stats` åš 3 æ¬¡ COUNT æŸ¥è¯¢
- **æ–‡ä»¶**ï¼š`routers/admin.py` L750-770
- **æ–¹æ¡ˆ**ï¼šä¸€æ¬¡ `CASE/WHEN` èšåˆæŸ¥è¯¢
- **âœ… å·²å®Œæˆ**ï¼š3 æ¬¡ COUNT åˆå¹¶ä¸º 1 æ¬¡ `SUM(CASE WHEN ... THEN 1 ELSE 0 END)` æŸ¥è¯¢

### 32. âœ… å¤šå¤„ `import asyncio` åš fire-and-forget ä»£ç å†—ä½™
- **æ–‡ä»¶**ï¼š`auth.py`ã€`level_service.py`ã€`likes.py`ã€`notifications.py`ã€`moderation.py`
- **æ–¹æ¡ˆ**ï¼šæå–ä¸ºå·¥å…·å‡½æ•° `fire_and_forget(coro)`
- **âœ… å·²å®Œæˆ**ï¼šåœ¨ `redis_client.py` ä¸­æ–°å¢ `fire_and_forget()` å·¥å…·å‡½æ•°ï¼Œé‡æ„ 9 å¤„è°ƒç”¨ç‚¹

---

## å®æ–½ä¼˜å…ˆçº§æ’åº

| åºå· | ä¼˜åŒ–é¡¹ | ä¼˜å…ˆçº§ | éš¾åº¦ | é¢„ä¼°æ”¶ç›Š | çŠ¶æ€ |
|------|--------|--------|------|----------|------|
| 3 | SECRET_KEY é»˜è®¤å€¼æ£€æŸ¥ | P0 | ä½ | â­â­â­â­â­ | âœ… å·²å®Œæˆ |
| 6 | Redis ç”¨æˆ·ç¼“å­˜ä¿®å¤ (bioâ†’persona) | P1 | ä½ | â­â­â­â­â­ | âœ… å·²å®Œæˆ |
| 2 | CORS é…ç½®ä¿®å¤ | P0 | ä½ | â­â­â­â­ | âœ… å·²å®Œæˆ |
| 10 | åˆ å¸–/åˆ ç”¨æˆ·è¡¥å……æ¸…ç† | P1 | ä½ | â­â­â­â­ | âœ… å·²å®Œæˆ |
| 1 | async def â†’ defï¼ˆçŸ­æœŸæ–¹æ¡ˆï¼‰ | P0 | ä¸­ | â­â­â­â­â­ | âœ… å·²å®Œæˆ |
| 14 | è¡¥å……æ•°æ®åº“ç´¢å¼• | P2 | ä½ | â­â­â­â­ | âœ… å·²å®Œæˆ |
| 4 | view_count æ‰¹é‡å›å†™ä¼˜åŒ– | P0 | ä¸­ | â­â­â­ | âœ… å·²å®Œæˆ |
| 7 | N+1 æŸ¥è¯¢ä¿®å¤ | P1 | ä¸­ | â­â­â­â­ | âœ… å·²å®Œæˆ |
| 11 | ç‚¹èµå†—ä½™æŸ¥è¯¢ | P1 | ä½ | â­â­ | âœ… å·²å®Œæˆ |
| 8 | æœç´¢å…¨æ–‡ç´¢å¼• | P1 | é«˜ | â­â­â­â­â­ | ğŸ”² å¾…å®æ–½ |
| 15 | å†…å­˜ç¼“å­˜åŠ ä¸Šé™ | P2 | ä½ | â­â­â­ | âœ… å·²å®Œæˆ |
| 5 | å®¡æ ¸æ‰¹é‡åŒ– | P0 | ä¸­ | â­â­â­ | ğŸ”² å¾…å®æ–½ |
| 22 | datetime.utcnow åºŸå¼ƒä¿®å¤ | P3 | ä½ | â­ | âœ… å·²å®Œæˆ |
| 24 | å¤´åƒä¸Šä¼  Rate Limit | P3 | ä½ | â­â­ | âœ… å·²å®Œæˆ |
| 25 | è·¯å¾„ç©¿è¶Šé˜²æŠ¤ | P3 | ä½ | â­â­â­ | âœ… å·²å®Œæˆ |
| 26 | schemas é‡å¤å®šä¹‰æ¸…ç† | P3 | ä½ | â­ | âœ… å·²å®Œæˆ |
| 9 | get_blocked_user_ids Redis ç¼“å­˜ | P1 | ä¸­ | â­â­ | âœ… å·²å®Œæˆ |
| 12 | å¸–å­åˆ—è¡¨ COUNT åˆå¹¶ | P1 | ä¸­ | â­â­â­ | âœ… å·²å®Œæˆ |
| 16 | å¸–å­åˆ—è¡¨ content å»¶è¿ŸåŠ è½½ | P2 | ä½ | â­â­â­ | âœ… å·²å®Œæˆ |
| 13 | ContentModerator ç¼“å­˜å®‰å…¨ | P2 | ä¸­ | â­â­ | âœ… å·²å®Œæˆ |
| 17 | httpx.AsyncClient å¤ç”¨ | P2 | ä½ | â­â­ | âœ… å·²å®Œæˆ |
| 21 | admin.get_stats COUNT åˆå¹¶ | P2 | ä½ | â­â­ | âœ… å·²å®Œæˆ |
| 31 | moderation_stats COUNT åˆå¹¶ | P3 | ä½ | â­ | âœ… å·²å®Œæˆ |

---

## ç¬¬ä¸€æ‰¹ä¼˜åŒ–å®Œæˆæ€»ç»“ï¼ˆ2026-02-09ï¼‰

å·²å®Œæˆ **27 / 32** é¡¹ä¼˜åŒ–ï¼ˆ#1-4, #6-7, #9-16, #17-27ï¼ˆè·³è¿‡#5/#8ï¼‰, #30-32ï¼‰ï¼Œæ¶µç›–ï¼š
- ğŸ”’ **å®‰å…¨ä¿®å¤ 3 é¡¹**ï¼šSECRET_KEY æ£€æŸ¥ã€CORS åŸŸåé™å®šã€è·¯å¾„ç©¿è¶Šé˜²æŠ¤
- âš¡ **æ€§èƒ½ä¿®å¤ 14 é¡¹**ï¼šäº‹ä»¶å¾ªç¯é˜»å¡è§£é™¤ã€æµè§ˆé‡å›å†™ä¼˜åŒ–ã€N+1 æŸ¥è¯¢ä¿®å¤ã€æ‹‰é»‘ Redis ç¼“å­˜ã€å¸–å­åˆ—è¡¨ COUNT+content ä¼˜åŒ–ã€httpx å¤ç”¨ã€å®¡æ ¸å™¨ç¼“å­˜å®‰å…¨ã€ç»Ÿè®¡ COUNT åˆå¹¶ã€FOR UPDATE é”ä¼˜åŒ–ã€OAuth æŸ¥è¯¢åˆå¹¶ã€Redis ç”¨æˆ·ç¼“å­˜ã€ç‚¹èµä¼˜åŒ–ã€DB ç´¢å¼•+å†…å­˜ç¼“å­˜é™å®¹
- ğŸ—ƒï¸ **æ•°æ®å®Œæ•´æ€§ 2 é¡¹**ï¼šåˆ å¸–/åˆ ç”¨æˆ·å…³è”æ¸…ç†ã€æ³¨é”€è´¦å·å…³è”è¡¨æ¸…ç†
- ğŸ§¹ **ä»£ç è´¨é‡ 8 é¡¹**ï¼šdatetime åºŸå¼ƒ APIã€å¤´åƒé™æµã€schemas å»é‡ã€æ­»ä»£ç æ¸…ç†ã€printâ†’loggerã€uuid ç”¨æˆ·åã€fire_and_forget æå–ã€å®¡æ ¸ç»Ÿè®¡ COUNT åˆå¹¶

**æœªå®æ–½ 5 é¡¹**ï¼š
- #5 å®¡æ ¸æ‰¹é‡åŒ–ï¼ˆç”¨æˆ·è·³è¿‡ï¼‰
- #8 æœç´¢å…¨æ–‡ç´¢å¼•ï¼ˆé«˜éš¾åº¦ï¼Œéœ€ PostgreSQL æ‰©å±•ï¼‰
- #28 Alembic è¿ç§»ç®¡ç†ï¼ˆæ¶æ„å˜æ›´ï¼‰
- #29 æ‹‰é»‘åˆ—è¡¨åˆ†é¡µï¼ˆåŠŸèƒ½å˜æ›´ï¼‰

**ä¾èµ–è¡¥å……**ï¼šéœ€åœ¨ `requirements.txt` ä¸­æ·»åŠ  `cachetools`ï¼ˆå·²åš try/except é™çº§å…¼å®¹ï¼‰

---

## é¢„æœŸæ€»ä½“æ•ˆæœ

- è®¤è¯è¯·æ±‚å»¶è¿Ÿï¼š~50ms â†’ ~5msï¼ˆRedis ç¼“å­˜ç”Ÿæ•ˆåï¼‰âœ… å·²ä¿®å¤ç¼“å­˜
- å¸–å­è¯¦æƒ…é¡µæŸ¥è¯¢æ•°ï¼š~30+ æ¬¡ â†’ ~3 æ¬¡ï¼ˆå¾… #7 N+1 ä¿®å¤ï¼‰âœ… å·²ç¡®è®¤ joinedload æ­£ç¡® + lazy="raise" é˜²æŠ¤
- å¸–å­åˆ—è¡¨æŸ¥è¯¢ï¼š~3 æ¬¡ DB å¾€è¿” â†’ ~1 æ¬¡ï¼ˆå¾… #12 çª—å£å‡½æ•°ï¼‰âœ… å·²åˆå¹¶ä¸º 1 æ¬¡å¾€è¿”
- é«˜å¹¶å‘ååé‡ï¼šæå‡ 5-10 å€ï¼ˆå¾… #1 è§£é™¤äº‹ä»¶å¾ªç¯é˜»å¡ï¼‰âœ… å·²ä¿®å¤ï¼ˆçŸ­æœŸæ–¹æ¡ˆï¼‰
- æœç´¢æ€§èƒ½ï¼šO(N) å…¨è¡¨æ‰«æ â†’ O(log N) ç´¢å¼•æŸ¥è¯¢ï¼ˆå¾… #8 å…¨æ–‡ç´¢å¼•ï¼‰
